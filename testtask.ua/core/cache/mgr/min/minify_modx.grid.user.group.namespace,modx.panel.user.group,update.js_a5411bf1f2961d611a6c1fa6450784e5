MODx.grid.UserGroupNamespace=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{permissions}</p>')});Ext.applyIf(config,{id:'modx-grid-user-group-namespace',url:MODx.config.connector_url,baseParams:{action:'security/access/usergroup/namespace/getList',usergroup:config.usergroup},paging:true,hideMode:'offsets',fields:['id','target','name','principal','authority','authority_name','policy','context_key','policy_name','permissions','menu'],grouping:true,groupBy:'authority_name',singleText:_('policy'),pluralText:_('policies'),sortBy:'authority',sortDir:'ASC',remoteSort:true,plugins:[this.exp],columns:[this.exp,{header:_('namespace'),dataIndex:'name',width:120,sortable:true},{header:_('minimum_role'),dataIndex:'authority_name',width:100},{header:_('policy'),dataIndex:'policy_name',width:200}],tbar:[{text:_('namespace_add'),cls:'primary-button',scope:this,handler:this.createAcl},'->',{xtype:'modx-combo-namespace',id:'modx-ugnamespace-namespace-filter',emptyText:_('filter_by_namespace'),width:200,allowBlank:true,listeners:{'select':{fn:this.filterNamespace,scope:this}}},{xtype:'modx-combo-policy',id:'modx-ugnamespace-policy-filter',emptyText:_('filter_by_policy'),allowBlank:true,baseParams:{action:'security/access/policy/getList',group:'Namespace'},listeners:{'select':{fn:this.filterPolicy,scope:this}}},{text:_('clear_filter'),id:'modx-ugnamespace-clear-filter',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupNamespace.superclass.constructor.call(this,config);this.addEvents('createAcl','updateAcl');};Ext.extend(MODx.grid.UserGroupNamespace,MODx.grid.Grid,{combos:{},windows:{},filterNamespace:function(cb,rec,ri){this.getStore().baseParams['namespace']=rec.data['name'];this.getBottomToolbar().changePage(1);},filterPolicy:function(cb,rec,ri){this.getStore().baseParams['policy']=rec.data['id'];this.getBottomToolbar().changePage(1);},clearFilter:function(btn,e){Ext.getCmp('modx-ugnamespace-namespace-filter').setValue('');this.getStore().baseParams['source']='';Ext.getCmp('modx-ugnamespace-policy-filter').setValue('');this.getStore().baseParams['policy']='';this.getBottomToolbar().changePage(1);},createAcl:function(itm,e){var r={principal:this.config.usergroup};if(!this.windows.createAcl){this.windows.createAcl=MODx.load({xtype:'modx-window-user-group-namespace-create',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('createAcl',r);},scope:this}}});}
this.windows.createAcl.setValues(r);this.windows.createAcl.show(e.target);},updateAcl:function(itm,e){var r=this.menu.record;if(!this.windows.updateAcl){this.windows.updateAcl=MODx.load({xtype:'modx-window-user-group-namespace-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateAcl',r);},scope:this}}});}
this.windows.updateAcl.setValues(r);this.windows.updateAcl.show(e.target);}});Ext.reg('modx-grid-user-group-namespace',MODx.grid.UserGroupNamespace);MODx.window.CreateUGNamespace=function(config){config=config||{};this.ident=config.ident||'cugnamespace'+Ext.id();Ext.applyIf(config,{title:_('namespace_add'),url:MODx.config.connector_url,action:'security/access/usergroup/namespace/create',fields:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'principal',hiddenName:'principal'},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'hidden',name:'context_key',hiddenName:'context_key',value:'mgr'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),description:MODx.expandHelp?'':_('user_group_source_source_desc'),id:'modx-'+this.ident+'-namespace',name:'target',hiddenName:'target',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-source',html:_('user_group_source_source_desc'),cls:'desc-under'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),description:MODx.expandHelp?'':_('user_group_source_authority_desc'),id:'modx-'+this.ident+'-authority',name:'authority',value:0,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-authority',html:_('user_group_source_authority_desc'),cls:'desc-under'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),description:MODx.expandHelp?'':_('user_group_source_policy_desc'),id:'modx-'+this.ident+'-policy',name:'policy',hiddenName:'policy',baseParams:{action:'security/access/policy/getList',group:'Namespace'},anchor:'100%',listeners:{'select':{fn:this.onPolicySelect,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-policy',html:_('user_group_source_policy_desc'),cls:'desc-under'},{id:'modx-'+this.ident+'-permissions-list-ct',cls:'modx-permissions-list',defaults:{border:false},autoHeight:true,hidden:true,anchor:'100%',items:[{html:'<h4>'+_('permissions_in_policy')+'</h4>',id:'modx-'+this.ident+'-permissions-list-header'},{id:'modx-'+this.ident+'-permissions-list',cls:'modx-permissions-list-textarea',xtype:'textarea',name:'permissions',grow:false,anchor:'100%',height:100,width:'97%',readOnly:true}]}]});MODx.window.CreateUGNamespace.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateUGNamespace,MODx.Window,{onPolicySelect:function(cb,rec,idx){var s=cb.getStore();if(!s)return;var r=s.getAt(idx);var lc=Ext.getCmp('modx-'+this.ident+'-permissions-list-ct');if(r&&idx>0){lc.show();var pl=Ext.getCmp('modx-'+this.ident+'-permissions-list');var o=rec.data.permissions.join(', ');pl.setValue(o);}else{lc.hide();}
this.doLayout();}});Ext.reg('modx-window-user-group-namespace-create',MODx.window.CreateUGNamespace);MODx.window.UpdateUGNamespace=function(config){config=config||{};this.ident=config.ident||'updugsrc'+Ext.id();Ext.applyIf(config,{title:_('access_namespace_update'),action:'security/access/usergroup/namespace/update'});MODx.window.UpdateUGNamespace.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUGNamespace,MODx.window.CreateUGNamespace);Ext.reg('modx-window-user-group-namespace-update',MODx.window.UpdateUGNamespace);;MODx.panel.UserGroup=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-user-group',cls:'container form-with-labels',url:MODx.config.connector_url,baseParams:{action:'security/group/update'},defaults:{collapsible:false,autoHeight:true},items:[{html:'<h2>'+_('user_group_new')+'</h2>',border:false,cls:'modx-page-header',id:'modx-user-group-header'},{xtype:'modx-tabs',defaults:{autoHeight:true,border:true,bodyCssClass:'tab-panel-wrapper'},id:'modx-usergroup-tabs',forceLayout:true,deferredRender:false,stateful:true,stateId:'modx-usergroup-tabpanel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:[{title:_('general_information'),defaults:{border:false,msgTarget:'side'},layout:'form',id:'modx-usergroup-form',labelAlign:'top',labelSeparator:'',items:[{xtype:'panel',border:false,cls:'main-wrapper',layout:'form',items:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',labelSeparator:'',anchor:'100%',border:false},items:[{columnWidth:.6,items:[{xtype:'hidden',name:'id',id:'modx-usergroup-id',value:config.record.id},{name:'name',id:'modx-usergroup-name',xtype:config.record&&(config.record.name=='Administrator'||config.record.id==0)?'statictextfield':'textfield',fieldLabel:_('name')+'<span class="required">*</span>',allowBlank:false,enableKeyEvents:true,disabled:config.record.id===0,anchor:'100%',listeners:{'keyup':{scope:this,fn:function(f,e){Ext.getCmp('modx-user-group-header').getEl().update('<h2>'+_('user_group')+': '+f.getValue()+'</h2>');}}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-name',html:_('user_group_desc_name'),cls:'desc-under'},{name:'description',id:'modx-usergroup-description',xtype:'textarea',fieldLabel:_('description'),anchor:'100%',grow:true},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-description',html:_('user_group_desc_description'),cls:'desc-under'}]},{columnWidth:.4,items:[{name:'parent',hiddenName:'parent',id:'modx-usergroup-parent',xtype:'modx-combo-usergroup',fieldLabel:_('user_group_parent'),editable:false,anchor:'100%',disabled:config.record.id===0,baseParams:{action:'security/group/getList',addNone:true,exclude:config.record.id}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-parent',html:_('user_group_desc_parent'),cls:'desc-under'},{name:'dashboard',id:'modx-usergroup-dashboard',xtype:'modx-combo-dashboard',fieldLabel:_('dashboard'),anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-dashboard',html:_('user_group_desc_dashboard'),cls:'desc-under'}]}]}]}]},{title:_('users'),hideMode:'offsets',layout:'form',id:'modx-usergroup-users-panel',items:[{html:'<p>'+_('user_group_user_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-users',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'updateRole':{fn:this.markDirty,scope:this},'addMember':{fn:this.markDirty,scope:this}}}]},{title:_('settings'),forceLayout:true,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_settings_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-group-settings',cls:'main-wrapper',preventRender:true,group:config.record.id,autoHeight:true,width:'97%'}]},{title:_('permissions'),hidden:config.record.id===0,forceLayout:true,hideMode:'offsets',items:[{xtype:'modx-vtabs',items:[{title:_('user_group_context_access'),forceLayout:true,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_context_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-context',preventRender:true,usergroup:config.record.id,autoHeight:true,cls:'main-wrapper',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_resourcegroup_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_resourcegroup_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-resource-group',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_category_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_category_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-category',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_source_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_source_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-source',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_namespace_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_namespace_access_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-namespace',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%'}]}]}]}]}],useLoadingMask:false,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.UserGroup.superclass.constructor.call(this,config);if(config.record.id==0||MODx.perm.usergroup_user_list==0){var tbs=Ext.getCmp('modx-usergroup-tabs');tbs.hideTabStripItem('modx-usergroup-users-panel');}};Ext.extend(MODx.panel.UserGroup,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized||this.config.usergroup===''||this.config.usergroup==undefined){this.fireEvent('ready');return false;}
var r=this.config.record;this.getForm().setValues(r);Ext.defer(function(){Ext.get('modx-user-group-header').update('<h2>'+_('user_group')+': '+r.name+'</h2>');},250,this);this.fireEvent('ready',r);MODx.fireEvent('ready');this.initialized=true;},beforeSubmit:function(o){},success:function(o){}});Ext.reg('modx-panel-user-group',MODx.panel.UserGroup);MODx.grid.UserGroupUsers=function(config){config=config||{};Ext.applyIf(config,{title:'',id:'modx-grid-user-group-users',url:MODx.config.connector_url,baseParams:{action:'security/group/user/getList',usergroup:config.usergroup},paging:true,grouping:true,remoteSort:true,groupBy:'role_name',singleText:_('user'),pluralText:_('users'),sortBy:'authority',sortDir:'ASC',fields:['id','username','role','role_name','authority'],columns:[{header:_('username'),dataIndex:'username',width:175,sortable:true},{header:_('role'),dataIndex:'role_name',width:175,sortable:true}],tbar:[{text:_('user_group_user_add'),cls:'primary-button',handler:this.addMember,hidden:MODx.perm.usergroup_user_edit==0},'->',{xtype:'textfield',id:'modx-ugu-filter-username',cls:'x-form-filter',listeners:{'change':{fn:this.searchUser,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});}}},emptyText:_('search'),scope:this},{text:_('clear_filter'),id:'modx-ugu-clear-filter',cls:'x-form-filter-clear',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupUsers.superclass.constructor.call(this,config);this.addEvents('updateRole','addMember');};Ext.extend(MODx.grid.UserGroupUsers,MODx.grid.Grid,{getMenu:function(){var m=[];if(MODx.perm.usergroup_user_edit){m.push({text:_('user_role_update'),handler:this.updateRole});m.push('-');m.push({text:_('user_group_user_remove'),handler:this.removeUser});}
return m;},searchUser:function(tf,nv,ov){this.getStore().baseParams['username']=Ext.getCmp('modx-ugu-filter-username').getValue();this.getBottomToolbar().changePage(1);},clearFilter:function(btn,e){Ext.getCmp('modx-ugu-filter-username').setValue('');this.getStore().baseParams['username']='';this.getBottomToolbar().changePage(1);},updateRole:function(btn,e){var r=this.menu.record;r.usergroup=this.config.usergroup;r.user=r.id;this.loadWindow(btn,e,{xtype:'modx-window-user-group-role-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateRole',r);},scope:this}}});},addMember:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-user-group-adduser',record:{usergroup:this.config.usergroup},listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('addMember',r);},scope:this}}});},removeUser:function(btn,e){var r=this.menu.record;MODx.msg.confirm({title:_('warning'),text:_('user_group_user_remove_confirm')||_('confirm_remove'),url:this.config.url,params:{action:'security/group/user/remove',user:r.id,usergroup:this.config.usergroup},listeners:{'success':{fn:this.refresh,scope:this}}});}});Ext.reg('modx-grid-user-group-users',MODx.grid.UserGroupUsers);MODx.window.UpdateUserGroupRole=function(config){config=config||{};Ext.applyIf(config,{id:'modx-window-user-group-role-update',title:_('user_group_user_update_role'),url:MODx.config.connector_url,action:'security/group/user/update',fields:[{xtype:'hidden',name:'usergroup',value:config.usergroup},{xtype:'hidden',name:'user',value:config.user},{xtype:'modx-combo-usergrouprole',id:'modx-uugr-role',name:'role',fieldLabel:_('role')}]});MODx.window.UpdateUserGroupRole.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUserGroupRole,MODx.Window);Ext.reg('modx-window-user-group-role-update',MODx.window.UpdateUserGroupRole);MODx.window.AddUserToUserGroup=function(config){config=config||{};this.ident=config.ident||'auug'+Ext.id();Ext.applyIf(config,{title:_('user_group_user_add'),url:MODx.config.connector_url,action:'security/group/user/create',fields:[{fieldLabel:_('user'),description:MODx.expandHelp?'':_('user_group_user_add_user_desc'),name:'user',hiddenName:'user',id:'modx-auug-user',xtype:'modx-combo-user',editable:true,typeAhead:true,allowBlank:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-user',html:_('user_group_user_add_user_desc'),cls:'desc-under'},{fieldLabel:_('role'),description:MODx.expandHelp?'':_('user_group_user_add_role_desc'),name:'role',hiddenName:'role',id:'modx-auug-role',xtype:'modx-combo-role',allowBlank:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-role',html:_('user_group_user_add_role_desc'),cls:'desc-under'},{name:'usergroup',xtype:'hidden'}]});MODx.window.AddUserToUserGroup.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddUserToUserGroup,MODx.Window);Ext.reg('modx-window-user-group-adduser',MODx.window.AddUserToUserGroup);;MODx.page.UpdateUserGroup=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-user-group',buttons:[{process:'security/group/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{text:_('cancel'),id:'modx-abtn-cancel',handler:function(){MODx.loadPage('security/permission')}},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-user-group',record:config.record||{},usergroup:MODx.request.id}]});MODx.page.UpdateUserGroup.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdateUserGroup,MODx.Component);Ext.reg('modx-page-user-group-update',MODx.page.UpdateUserGroup);